/*
https://lemgrant.github.io/eutest3dpca/
https://github.com/Lemgrant/
*/
var vm = new Vue({
  el: '#app',
  data: {
    inputValue: '',
    inputHasError: false,
    currentPCA: 0,
    pcaData: [
      
      { 
        name: '3D PCA',
        mlpca: {},
        mlpcaS: [21.7856625,20.78849954,17.76128084,15.16986356,14.80488631,10.59462522,9.313356315,6.359217683,5.005290874,3.968128882,2.758907562,2.138454941,0.002864919],
        mlpcaUdata: [
          [0.392430552009617,0.191877872482838,-0.103954408590743,-0.0515799320280605,0.0149947421933594,-0.32594284014205,-0.242963854284315,0.366979405835057,-0.0646304102644306,-0.296593749607958,0.539211287070087,0.188961942326742,0.277389382149413],
          [0.245235980305712,0.195700184826476,-0.243611284478377,0.0394851502827457,-0.0760936094035631,-0.349015783191837,-0.227799566308756,0.119999726895489,-0.16994350756456,0.311284023974254,-0.665739634045097,-0.0300150292215477,0.277257432302873],
          [0.392676501493699,0.12075168319575,-0.0337120642305527,-0.109620056031797,0.0289515162114798,0.120962816440466,0.0821364253844241,-0.275175672278225,0.356283098280572,-0.0270864909640179,0.0856714633250045,-0.712794576460641,0.277571374617423],
          [0.372173699784275,0.0873701758436501,0.0271472841877965,-0.119818749511386,0.0408098140099997,0.337080859232923,0.184802972676869,-0.333987238589851,0.23376934923391,0.080315788011538,-0.0953636983296558,0.656326242115321,0.277153415031065],
          [0.165341645738449,-0.126048639026083,0.192256086492512,-0.117795985432431,-0.032899860874842,0.508236544879413,0.179963345115875,0.311333691646561,-0.643915759424234,0.0456374014166888,-0.0135041636404532,-0.152984093975343,0.277374388115775],
          [-0.0794316818751151,-0.507056564509643,0.226527242353254,-0.270155763188826,-0.345432702420611,-0.142050770171168,0.0768129009037784,0.281561270915999,0.353877755922672,-0.333568749451246,-0.270857138018008,0.0282186279291701,0.277396682085603],
          [-0.133960005586624,-0.321219142729935,-0.202470131860047,-0.194634709873946,-0.215330214631524,-0.38862074530367,0.222754096194815,-0.484961258168339,-0.339128393523238,0.212097662033255,0.284084112370511,0.0140498779378288,0.277311184140629],
          [-0.107549546135861,-0.281598829220313,0.313379577094558,0.166122983314816,0.0601183892843558,0.134569550100045,-0.627943847085795,-0.0259380573254386,0.15303448526385,0.474219971909966,0.203416740946682,0.00651693139883846,0.27730339124658],
          [-0.317146266022887,-0.162162645693953,-0.76879276325541,0.0195760479080348,0.199538052315731,0.32981527294682,-0.0788160126396358,0.15437184819794,0.131175295230473,-0.0930289473143463,0.0153494747264595,0.00551790770366695,0.277366924941074],
          [-0.079179168428439,-0.0702235512444885,0.1806264080107,0.381643652197432,0.318778240025912,-0.0618927949299829,-0.178607637195846,-0.3853909727177,-0.240399740215912,-0.590026594369093,-0.204324923023935,-0.00639583964871011,0.277365036038598],
          [-0.479532658220189,0.471229988998565,0.233866279699586,-0.571863683482833,0.288478404811111,-0.0667258467244241,-0.0257180198458572,0.00702456153001444,0.00959629548749434,0.0118096352296484,-0.026799799141044,-0.00360946469521004,0.277350886762509],
          [-0.295850380942859,0.438762306001531,0.0338489237709332,0.396381165075924,-0.668538979659121,0.144619136151797,0.0672854331975817,-0.0168726537010186,0.0477575890530179,-0.0501501870378403,0.08532148797532,0.0044812060435455,0.277361982510798],
          [-0.0752324752725614,-0.0373819648294733,0.14487317975801,0.432303826297184,0.386645388297116,-0.241039456465947,0.568028260073577,0.280892387278862,0.172336582955445,0.255517008148265,0.0632275401489009,0.00273516036006749,0.277349006441222]
        ],
        mlpcaMeans: [10.62294384,10.64630435,11.43716486,10.8620471,8.549800725,11.74924819,9.120153986,5.876150362,6.029402174,2.638623188,4.727826087,5.262608696,2.478414855],
        mlpcaCenter: true,
        mlpcaScale: false,
        x: 0,
        y: 1,
		z: 2,
        flipX: 1,
        flipY: 1,
        flipZ: 1,
		tracesCount: 0,
        traces: [
          {
            text: ['Ashkenazi_Jew','Algerian','Armenian','Assyrian','Austrian','Balochi','Bangladeshi','Bedouin','Belorussian','Brahui','Burusho','Chinese','Chukchi','Cornish','Danish','Druze','East_Finnish','East_Russian','Estonian','English','Erzya','Spanish','Ethiopian','French','French_Basque','Georgian','Greek','Gujarati','Hungarian','Irish','IN','Iraqi','Iranian','Japanese','Kalash','Komi','Koryak','Korean','Kurdish','Kazakh','Lezgin','Lithuanian','Luhya','Maasai','Mandean','Moroccan','Mozabite_Berber','Nganassan','Dutch','Norwegian','North_Han_Chinese','North_Italian','North_Russian','North_Swedish','Northwest_Russian','Orcadian','Polish','Portuguese','Romanian','Samaritan','Sardinian','Scottish','Selkup','Serbian','Sindhi','Somali','South_&_Central_Swedish','South_Finnish','South_Indian','South_Italian_&_Sicilian','Turkish','Tuscan','Ukrainian','Udmurt','Ukrainian-Russian','West_&_Central_German','West_Russian','Yoruba','Greek_Crete_1','Greek_Chios_1','Maltese_1','SerbianBosnia','UA_Sumy','Czech','Croatian','Bulgarian_1','Kosovar_1','Albanian_1','Moldavian_1','Slovakian_1','Slovenian_1','Cypriot'],
            x: [-0.572095323,-6.074154862,-13.18357558,-13.93961888,18.1664586,-21.44751928,-31.5876579,-16.65847521,23.26858062,-21.46726752,-24.10291305,-54.65224752,-36.05288635,22.21913085,23.23779064,-12.58916364,20.06495335,17.85685401,25.04300038,22.47355018,16.81360187,15.26451013,-16.5840008,18.46193355,21.1910925,-13.10315301,-0.2936004,-28.22047111,16.80212301,22.7283141,-27.54030743,-15.95945299,-14.6579115,-51.83348136,-17.79333458,11.48599538,-36.9075346,-52.24072164,-14.08770738,-24.92636434,-6.34257373,25.45977342,-15.53625148,-16.1434393,-16.11453791,-2.446109581,-6.702308026,-35.32769887,21.74209509,23.98148597,-53.72531722,11.41616823,19.26038618,22.91467875,23.67597853,22.97123348,22.18865795,14.04655922,11.74471959,-13.83384292,8.77096364,23.5221608,-17.2666003,13.47049253,-23.83204796,-16.80403512,24.03609685,22.5253509,-37.00248661,0.196605945,-11.31718956,7.937215509,21.1980321,10.95929817,20.30570416,21.02356173,20.90765339,-15.47752859,-1.394208159,-1.448425505,1.01954743,15.91214495,21.12632113,20.48182937,18.1402815,10.29960462,8.091345244,7.508797462,13.4956137,20.39797756,18.2333025,-6.849309668],
            y: [-17.16030527,-17.78584343,-31.3997933,-32.39058503,3.66250057,-21.79389535,-5.146937979,-32.39137665,13.51734479,-22.2070894,-7.450962717,48.37978839,42.974566,7.434123946,9.670776521,-34.84976533,18.32577198,15.72395063,16.3528025,7.461051247,17.07892679,-2.159731238,-15.98525559,1.846379223,3.200577206,-28.19121227,-20.11227054,-12.55027973,3.940160516,8.824379044,-12.17962616,-30.02116191,-25.55408249,47.9463586,-11.9533017,19.00207458,43.80984894,48.36957039,-27.50715291,27.36256239,-16.52069996,16.12201679,-3.416578655,-8.091547722,-33.45243979,-14.92863074,-15.90883536,44.67737371,7.243545875,11.5322836,48.30684368,-7.055300443,17.54038246,13.74800341,15.00259448,8.887874762,11.06192921,-2.89532641,-3.315840607,-34.6045067,-11.85820085,9.271641457,34.43897024,-1.565851936,-15.84727532,-13.38405808,11.52158432,17.44573042,-10.1542185,-19.51812574,-22.72846364,-11.69695327,10.5727946,18.6724914,11.26920525,6.342699997,12.57148898,-2.6834765,-20.69930768,-21.64181486,-18.28470591,1.596271446,11.93135534,7.539936761,5.151245197,-5.335326088,-9.812490297,-9.333919373,1.396456984,7.542510681,4.929405974,-27.67562785],
			z: [11.01804141,22.52257942,6.278235866,8.541092153,0.052079323,-28.02466621,-48.53582172,28.66100554,-6.770201977,-27.22647069,-35.65979141,23.71227074,4.46280714,0.137756783,-1.90136589,16.67772347,-7.915273655,-8.250634022,-7.627328614,0.105851498,-8.961805218,9.195972855,25.55557463,4.665316759,7.599706547,-2.314045972,10.99830158,-54.90734486,-0.206879161,-1.684737956,-51.23108831,9.796706357,-3.282041342,20.64922126,-36.98167823,-9.429264072,5.419752558,21.57099857,-1.206757468,0.388133009,-10.72442724,-7.902101126,17.85979178,21.48043155,8.085144857,21.63430306,23.89294633,4.417071498,-0.610659348,-2.794774957,23.01023135,8.331163197,-9.126907598,-4.292492842,-7.469651037,-1.27418616,-4.993844853,9.34701781,2.470920961,20.61913231,17.8559269,-1.360782985,-5.648403753,1.695754387,-42.78163555,25.12202795,-3.276769494,-6.040766447,-62.61896121,12.66583964,4.114271358,10.14037266,-5.276093737,-10.17699607,-6.081339065,-0.250424941,-6.329768913,17.12829312,10.63043617,10.45623923,14.10919864,0.472713176,-5.132540293,-2.704850348,-1.25821738,3.136576115,7.281802248,6.297950235,-0.175207453,-2.856584118,-1.522525325,14.53342499],
            mode: 'markers+text',
            type: 'scatter3d',
            name: 'EUtest',
            marker: { size: 6, symbol: 1,colorscale: 'redblue',opacity: 0.8, showscale: false, colorscale:[["0","rgb(158,1,66)"],[0.1,"rgb(213,62,79)"],[0.2,"rgb(244,109,67)"],[0.3,"rgb(253,174,97)"],[0.4,"rgb(254,224,139)"],[0.5,"rgb(255,255,191)"],[0.6,"rgb(230,245,152)"],[0.7,"rgb(171,221,164)"],[0.8,"rgb(102,194,165)"],[0.9,"rgb(50,136,189)"],[1,"rgb(94,79,162)"]],color:[-0.572095323016474,-6.0741548616751,-13.1835755810123,-13.9396188799963,18.1664586035407,-21.4475192753553,-31.5876579048518,-16.6584752056345,23.2685806168844,-21.4672675190801,-24.1029130543457,-54.6522475151027,-36.0528863524359,22.2191308520121,23.2377906406705,-12.5891636381647,20.0649533537231,17.856854007756,25.0430003788772,22.4735501838216,16.8136018709557,15.2645101266379,-16.584000802854,18.4619335521769,21.1910924969278,-13.1031530067921,-0.293600399582652,-28.2204711057855,16.8021230056288,22.728314095004,-27.5403074347007,-15.959452989523,-14.6579115024382,-51.8334813626423,-17.7933345849598,11.4859953759784,-36.9075345991967,-52.2407216386424,-14.0877073801353,-24.9263643430961,-6.34257373028655,25.4597734233006,-15.536251479014,-16.1434392998813,-16.1145379063206,-2.44610958119547,-6.70230802604286,-35.3276988653774,21.7420950927306,23.9814859746123,-53.7253172163544,11.4161682266938,19.2603861815174,22.914678750349,23.6759785297342,22.9712334752584,22.188657952632,14.0465592198592,11.7447195921044,-13.8338429176609,8.7709636396045,23.5221608026971,-17.266600297024,13.4704925348594,-23.832047961673,-16.8040351221184,24.0360968452385,22.5253508978961,-37.002486609645,0.196605944585651,-11.317189561252,7.9372155093308,21.1980321013359,10.9592981651074,20.3057041552727,21.0235617315193,20.9076533930877,-15.4775285946282,-1.39420815878808,-1.44842550544962,1.01954742956237,15.9121449548129,21.1263211277308,20.4818293694838,18.1402814992374,10.2996046164132,8.09134524376486,7.50879746246047,13.4956136957082,20.3979775641301,18.2333024982402,-6.84930966773488]}
			
          },
          
        ],
		
        initialLayout: '',
        layout: {
			paper_bgcolor: '#787c8a',
  plot_bgcolor: '#c7c7c7',
		margin: {
    l: 0,
    r: 0,
    b: 0,
    t: 60,
    
  },	         
		scene:{
		  bgcolor:'#0d0d0d',
		  plot_bgcolor:'#0d0d0d',
		 paper_bgcolor:'#0d0d0d',
		 gridcolor:'#dbdbdb',
		 gridwidth:'0.5'},
		 legend:{font:{color:'#D9D9D9', bgcolor: '#000000'}},
          xaxis: {
			  
            zeroline: false,
			
          },
		  titlefont:{color:'#171717'},
		  autosize: true,
		  font: {
    family: 'Arial',
    size: 10,
    color: '#bdbdbd'
  },
          yaxis: {
            zeroline: false,
			
          },
		  
          hovermode: 'closest',
          dragmode: 'pan',
          title: 'Eurogenes EUtest 3D PCA by Lemgrant'
        }
      },
      
      
      
      
      
      
    ]
  },
  methods: {
    plotPCA: function (index) {
      this.currentPCA = index;
      Plotly.newPlot('graphDiv', this.pcaData[index].traces , this.pcaData[index].layout, {showSendToCloud: false, responsive: true});
    },
    addtrace: function () {
      this.inputValue = this.inputValue.replace(/[^\S]/g, '').replace(/\"/g,'').replace(/\</g, '&lt;').replace(/\>/g, '&gt;');
      let i, input = this.inputValue.split(","), hasNumbers = true, inputName, predicted;
      const inputLen = input.length,  dataset = [], currentPcaData = this.pcaData[this.currentPCA];
      for (i = 1; i < inputLen; i++) {
        input[i] = Number(input[i]);
        if (isNaN(input[i])) {
          hasNumbers = false;
        }
      };
      if (inputLen == 14 && hasNumbers) {
        inputName = input[0];
        input.shift();
        dataset[0] = input;
        predicted = currentPcaData.mlpca.predict(dataset);
        Plotly.addTraces(graphDiv, {x: [Number((predicted.data[0][currentPcaData.x] * currentPcaData.flipX).toFixed(0))], y: [Number((predicted.data[0][currentPcaData.y] * currentPcaData.flipY).toFixed(0))],z: [Number((predicted.data[0][currentPcaData.z] * currentPcaData.flipX).toFixed(0))], mode: 'markers+text', type: 'scatter3d', name: inputName, text: [inputName],  marker: { size: 5 },textfont: {family:'Arial', size: 11, color: '#ff0000'}});
      }
      else {
        this.inputHasError = true;
      };
    },
    resetAll: function () {
      for (let item of this.pcaData) {
        item.traces = item.traces.slice(0, item.tracesCount);
        item.layout = JSON.parse(item.initialLayout);
        for (let trace of item.traces) {
          delete trace.visible;
          delete trace.selectedpoints;
        }
      }
      this.inputValue = '';
      this.plotPCA(0);
    }
  },
  created: function () {
    let i, j;
    const dummyCoordinates = Array(13);
    for (i = 0; i < 13; i++) {
      dummyCoordinates[i] = Array(13);
      for (j = 0; j < 13; j++) {
        dummyCoordinates[i][j] = Math.random();
      }
    }
    for (let item of this.pcaData) {
      item.tracesCount = item.traces.length;
      item.initialLayout = JSON.stringify(item.layout);
      item.mlpca = new ML.PCA(dummyCoordinates);
      item.mlpca.S = item.mlpcaS;
      item.mlpca.means = item.mlpcaMeans;
      item.mlpca.center = item.mlpcaCenter;
      item.mlpca.scale = item.mlpcaScale;
      for (i = 0; i < 13; i++) {
        for (j = 0; j < 13; j++) {
          item.mlpca.U.data[i][j] = item.mlpcaUdata[i][j];
        }
      }
    }
  },
  mounted: function () {
    this.plotPCA(0);
  }
})

